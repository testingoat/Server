<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoatGoat Server Monitoring</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        (function () {
            const CHART_SRC = '/public/vendor/chart.umd.min.js';
            const state = {
                loading: false,
                loaded: false,
                retries: 0,
                maxRetries: 5,
                pending: []
            };

            function inject(forceBust = false) {
                if (state.loading || state.loaded) return;
                state.loading = true;
                const script = document.createElement('script');
                script.src = `${CHART_SRC}${forceBust ? `?v=${Date.now()}` : ''}`;
                script.defer = true;
                script.onload = () => {
                    state.loading = false;
                    state.loaded = true;
                    const callbacks = state.pending.splice(0);
                    callbacks.forEach(({ resolve }) => resolve());
                };
                script.onerror = () => {
                    state.loading = false;
                    state.retries += 1;
                    if (state.retries >= state.maxRetries) {
                        const error = new Error('Chart.js failed to load');
                        const callbacks = state.pending.splice(0);
                        callbacks.forEach(({ reject }) => reject(error));
                    } else {
                        setTimeout(() => inject(true), 500 * state.retries);
                    }
                };
                document.head.appendChild(script);
            }

            window.__ensureChartJsReady = () => {
                if (window.Chart || state.loaded) return Promise.resolve();
                return new Promise((resolve, reject) => {
                    state.pending.push({ resolve, reject });
                    inject(state.retries > 0);
                });
            };

            inject(false);
        })();
    </script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --input-bg: rgba(15, 23, 42, 0.6);
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --glass-border: 1px solid rgba(255, 255, 255, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --success-bg: #10b981;
            --warning-bg: #f59e0b;
            --danger-bg: #ef4444;
            --info-bg: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            padding: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 24px;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }

        .btn-premium {
            background: var(--accent-gradient);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: none;
        }

        .btn-success {
            background: var(--success-bg);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--danger-bg);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-bottom: 24px;
        }

        /* Logs */
        .logs-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            margin-bottom: 6px;
            line-height: 1.4;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 4px;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: var(--text-muted);
            min-width: 140px;
        }

        .log-level {
            font-weight: bold;
            min-width: 60px;
        }

        .log-msg {
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .level-INFO {
            color: var(--info-bg);
        }

        .level-WARN {
            color: var(--warning-bg);
        }

        .level-ERROR {
            color: var(--danger-bg);
        }

        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .search-box {
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            outline: none;
            flex-grow: 1;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .time-range-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: #fff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>
            <h1>🚀 GoatGoat Server Monitoring</h1>
            <p>Real-time performance metrics & system health</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-premium btn-secondary" onclick="fetchData()">🔄 Refresh</button>
            <a href="/admin" class="btn-premium btn-secondary" style="text-decoration: none;">← Admin Panel</a>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
        <div>
            <div class="label">Uptime</div>
            <div class="value" id="uptime-stat" style="font-size: 1.5rem;">--</div>
        </div>
        <div>
            <div class="label">Memory</div>
            <div class="value" id="memory-stat" style="font-size: 1.5rem;">--%</div>
        </div>
    </div>
    </div>

    <div class="glass-card">
        <h2>⚡ Quick Actions</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-premium btn-danger btn-small" onclick="restartServer()">♻️ Restart
                Server</button>
            <button class="btn-premium btn-small" onclick="createBackup()" id="backup-btn">📦 Create
                Backup</button>
            <a href="/health" target="_blank" class="btn-premium btn-secondary btn-small"
                style="text-decoration: none;">🏥 Health Check</a>
        </div>
        <div id="backup-status" style="margin-top: 10px; font-size: 0.8rem;"></div>
    </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-2">
        <div class="glass-card">
            <h2>💾 Memory Usage</h2>
            <div class="chart-container">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <h2>🖥️ CPU Usage</h2>
            <div class="chart-container">
                <canvas id="cpuChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Backup History -->
    <div class="glass-card">
        <h2>
            📦 Backup History
            <button class="btn-premium btn-secondary btn-small" onclick="fetchBackups()">🔄 Refresh List</button>
        </h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-color);">
                <thead>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                        <th style="padding: 10px;">Filename</th>
                        <th style="padding: 10px;">Size</th>
                        <th style="padding: 10px;">Created</th>
                        <th style="padding: 10px;">Action</th>
                    </tr>
                </thead>
                <tbody id="backup-list">
                    <tr>
                        <td colspan="4" style="padding: 20px; text-align: center; color: var(--text-muted);">Loading
                            backups...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Real-time Logs -->
    <div class="glass-card">
        <h2>
            📋 Real-Time Logs
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="badge badge-success" id="ws-status">Connected</span>
                <button class="btn-premium btn-secondary btn-small" onclick="clearLogs()">Clear</button>
            </div>
        </h2>

        <div class="log-controls">
            <input type="text" class="search-box" placeholder="Search logs..." id="log-search" onkeyup="filterLogs()">
            <button class="btn-premium btn-secondary btn-small" onclick="setLogLevel('ALL')">ALL</button>
            <button class="btn-premium btn-secondary btn-small" onclick="setLogLevel('INFO')">INFO</button>
            <button class="btn-premium btn-secondary btn-small" onclick="setLogLevel('WARN')">WARN</button>
            <button class="btn-premium btn-secondary btn-small" onclick="setLogLevel('ERROR')">ERROR</button>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="auto-scroll" checked> <label for="auto-scroll">Auto-scroll</label>
            </div>
        </div>
        <div id="logs-container" class="logs-container"></div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">📊 Dashboard</button>
        <button class="tab-btn" onclick="switchTab('database')">💾 Database</button>
        <button class="tab-btn" onclick="switchTab('network')">🌐 Network</button>
        <button class="tab-btn" onclick="switchTab('query')">🔍 Query</button>
        <button class="tab-btn" onclick="switchTab('errors')">⚠️ Errors</button>
        <button class="tab-btn" onclick="switchTab('settings')">⚙️ Settings</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="grid">
            <div class="glass-card">
                <h2>🏥 Server Health</h2>
                <div class="metric-row"><span class="label">Status</span><span class="badge badge-success">✅
                        HEALTHY</span></div>
                <div class="metric-row"><span class="label">PID</span><span class="value" id="pid">--</span></div>
                <div class="metric-row"><span class="label">Node Version</span><span class="value"
                        id="nodeVersion">--</span></div>
                <div class="metric-row"><span class="label">Platform</span><span class="value" id="platform">--</span>
                </div>
            </div>

            <div class="glass-card">
                <h2>💾 Memory Details</h2>
                <div class="metric-row"><span class="label">RSS</span><span class="value" id="memory-rss">--</span>
                </div>
                <div class="metric-row"><span class="label">Heap Used</span><span class="value"
                        id="memory-heap">--</span></div>
                <div class="metric-row"><span class="label">CPU Usage</span><span class="value"
                        id="cpu-usage">--%</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="heap-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="glass-card">
                <h2>🖥️ System Info</h2>
                <div class="metric-row"><span class="label">Hostname</span><span class="value" id="hostname">--</span>
                </div>
                <div class="metric-row"><span class="label">CPUs</span><span class="value" id="cpus">--</span></div>
                <div class="metric-row"><span class="label">Load Avg</span><span class="value" id="load-avg">--</span>
                </div>
                <div class="metric-row"><span class="label">Project Size</span><span class="value"
                        id="project-size">--</span></div>
            </div>
        </div>
    </div>

    <!-- Tab: Database -->
    <div id="tab-database" class="tab-content">
        <div class="grid">
            <div class="glass-card">
                <h2>💾 Data Size</h2>
                <div class="value" id="db-data-size">--</div>
            </div>
            <div class="glass-card">
                <h2>🗂️ Index Size</h2>
                <div class="value" id="db-index-size">--</div>
            </div>
            <div class="glass-card">
                <h2>📄 Objects</h2>
                <div class="value" id="db-objects">--</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="glass-card">
                <h2>📊 Storage Distribution</h2>
                <div class="chart-container">
                    <canvas id="dbStorageChart"></canvas>
                </div>
            </div>
            <div class="glass-card">
                <h2>🔌 Connections</h2>
                <div class="metric-row"><span class="label">Current</span><span class="value"
                        id="db-conn-current">--</span></div>
                <div class="metric-row"><span class="label">Available</span><span class="value"
                        id="db-conn-available">--</span></div>
                <div class="metric-row"><span class="label">Active</span><span class="value"
                        id="db-conn-active">--</span></div>
            </div>
        </div>

        <div class="glass-card">
            <h2>📚 Collections</h2>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: var(--text-color);">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                            <th style="padding: 10px;">Name</th>
                            <th style="padding: 10px;">Documents</th>
                            <th style="padding: 10px;">Size</th>
                            <th style="padding: 10px;">Storage</th>
                            <th style="padding: 10px;">Indexes</th>
                        </tr>
                    </thead>
                    <tbody id="db-collections-list">
                        <tr>
                            <td colspan="5" style="padding: 20px; text-align: center; color: var(--text-muted);">
                                Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab: Network -->
    <div id="tab-network" class="tab-content">
        <div class="grid">
            <div class="glass-card">
                <h2>🌐 Active Connections</h2>
                <div class="value" id="net-connections">--</div>
            </div>
            <div class="glass-card">
                <h2>🚀 RPS</h2>
                <div class="value" id="net-rps">--</div>
            </div>
            <div class="glass-card">
                <h2>📡 Bandwidth</h2>
                <div class="value" id="net-bandwidth">--</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="glass-card">
                <h2>📈 Requests Per Second</h2>
                <div class="chart-container">
                    <canvas id="netRpsChart"></canvas>
                </div>
            </div>
            <div class="glass-card">
                <h2>⏱️ Average Latency (ms)</h2>
                <div class="chart-container">
                    <canvas id="netLatencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Query -->
    <div id="tab-query" class="tab-content">
        <div class="glass-card">
            <h2>🔍 MongoDB Query Tool</h2>
            <div class="grid grid-2">
                <div>
                    <label class="label">Collection</label>
                    <select id="query-collection" class="search-box" style="width: 100%; margin-bottom: 10px;">
                        <option value="">Select Collection</option>
                    </select>
                </div>
                <div>
                    <label class="label">Operation</label>
                    <select id="query-operation" class="search-box" style="width: 100%; margin-bottom: 10px;">
                        <option value="find">Find</option>
                        <option value="findOne">Find One</option>
                        <option value="count">Count</option>
                        <option value="aggregate">Aggregate</option>
                    </select>
                </div>
            </div>

            <label class="label">Query / Pipeline (JSON)</label>
            <textarea id="query-input" class="search-box"
                style="width: 100%; height: 150px; font-family: monospace; margin-bottom: 10px; background: rgba(0,0,0,0.2);">{}</textarea>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-premium btn-success" onclick="runQuery()">▶ Run Query</button>
                <button class="btn-premium btn-secondary" onclick="document.getElementById('query-input').value='{}'">🧹
                    Clear</button>
            </div>

            <label class="label">Results</label>
            <pre id="query-results"
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow: auto; max-height: 500px; font-family: monospace; color: #10b981;">// Results will appear here...</pre>
        </div>
    </div>

    <!-- Tab: Errors -->
    <div id="tab-errors" class="tab-content">
        <div class="glass-card">
            <h2>
                ⚠️ Error Tracking
                <div style="display: flex; gap: 10px;">
                    <select id="error-status-filter" class="search-box" onchange="fetchErrors()">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="investigating">Investigating</option>
                        <option value="resolved">Resolved</option>
                        <option value="ignored">Ignored</option>
                    </select>
                    <button class="btn-premium btn-secondary btn-small" onclick="fetchErrors()">🔄 Refresh</button>
                    <button class="btn-premium btn-danger btn-small" onclick="clearResolvedErrors()">🗑️ Clear
                        Resolved</button>
                </div>
            </h2>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: var(--text-color);">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                            <th style="padding: 10px;">Time</th>
                            <th style="padding: 10px;">Level</th>
                            <th style="padding: 10px;">Message</th>
                            <th style="padding: 10px;">Status</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="errors-list">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="errors-pagination">
                <!-- Pagination buttons -->
            </div>
        </div>
    </div>

    <!-- Tab: Settings -->
    <div id="tab-settings" class="tab-content">
        <div class="glass-card">
            <h2>⚙️ Environment Variables
                <button class="btn-premium btn-small" onclick="saveEnvVars()">💾 Save Changes</button>
            </h2>
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-premium btn-secondary btn-small" onclick="toggleMask()" id="mask-text">Show
                    Values</button>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-env-key" placeholder="KEY" class="search-box">
                    <input type="text" id="new-env-value" placeholder="VALUE" class="search-box">
                    <button class="btn-premium btn-success btn-small" onclick="addEnvVar()">➕ Add</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: var(--text-color);">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                            <th style="padding: 10px; width: 30%;">Key</th>
                            <th style="padding: 10px; width: 60%;">Value</th>
                            <th style="padding: 10px; width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="env-vars-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- End of Settings Tab -->

    <script>
                    // --- Global Variables ---
                const DEBUG = false;
                let memoryChart, cpuChart, dbStorageChart, netRpsChart, netLatencyChart;
                let logs = [];
                let currentLevel = 'ALL';
                let ws = null;
                let maxDataPoints = 30;
                let envVars = [];
                let showValues = false;
                let reconnectAttempts = 0;
                let reconnectTimer = null;
                const logHistoryLimit = 100;
                let errorPagination = { page: 1, limit: 50, totalPages: 1 };

                function __ensureChartJs(forceBust = false) {
                    const chartLoader = window['__ensureChartJsReady'];
                    if (typeof chartLoader === 'function') {
                        return chartLoader?.(forceBust);
                    }
                    return Promise.reject(new Error('Chart.js loader is unavailable'));
                }

                __ensureChartJs().catch(() => { });

                // Centralized fetch wrapper to ensure monitoring cookies flow to every request
                const authFetch = (url, options = {}) => {
                    return fetch(url, {
                        ...options,
                        credentials: 'include'
                    });
                };

                // --- Helper: Get Cookie ---
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                }

                // --- Tabs ---
                function switchTab(tabId) {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    // Find the button that was clicked (approximate)
                    const btns = document.querySelectorAll('.tab-btn');
                    btns.forEach(btn => {
                        if (btn.textContent.toLowerCase().includes(tabId)) {
                            btn.classList.add('active');
                        }
                    });

                    if (tabId === 'query') fetchCollections();
                    if (tabId === 'errors') fetchErrors();
                    if (tabId === 'settings') fetchEnvVars();
                }

                // --- Charts Initialization ---
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' }, beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                };

                async function initCharts() {
                    if (typeof Chart === 'undefined') {
                        console.warn('Chart.js not available yet. Waiting for loader...');
                        try {
                            await __ensureChartJs(true);
                        } catch (err) {
                            console.error('Failed to load Chart.js:', err);
                            return;
                        }
                    }
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js still unavailable after loading attempt.');
                        return;
                    }
                    // Memory
                      const ctxMem = document.getElementById('memoryChart').getContext('2d');
                    memoryChart = new Chart(ctxMem, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Heap Used MB',
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                fill: true,
                                data: [],
                                tension: 0.4
                            }]
                        },
                        options: commonOptions
                    });

                    // CPU
                      const ctxCpu = document.getElementById('cpuChart').getContext('2d');
                    cpuChart = new Chart(ctxCpu, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'CPU Usage %',
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                data: [],
                                tension: 0.4
                            }]
                        },
                        options: commonOptions
                    });

                      const ctxDbStorage = document.getElementById('dbStorageChart');
                      if (ctxDbStorage) {
                          dbStorageChart = new Chart(ctxDbStorage.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: ['Data Size', 'Index Size', 'Free Space'],
                                datasets: [{
                                    data: [0, 0, 0],
                                    backgroundColor: [
                                        'rgba(139, 92, 246, 0.8)',
                                        'rgba(59, 130, 246, 0.8)',
                                        'rgba(16, 185, 129, 0.8)'
                                    ],
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: { color: '#94a3b8' }
                                    }
                                }
                            }
                        });
                    }

                      const ctxNetRps = document.getElementById('netRpsChart');
                      if (ctxNetRps) {
                        netRpsChart = new Chart(ctxNetRps.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Requests/sec',
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    data: [],
                                    tension: 0.4
                                }]
                            },
                            options: commonOptions
                        });
                    }

                      const ctxNetLatency = document.getElementById('netLatencyChart');
                      if (ctxNetLatency) {
                        netLatencyChart = new Chart(ctxNetLatency.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Latency ms',
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    fill: true,
                                    data: [],
                                    tension: 0.4
                                }]
                            },
                            options: commonOptions
                        });
                    }
                }

                async function updateErrorStatus(id, status) {
                    try {
                        await authFetch(`/admin/monitoring/errors/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                        // Optional: refresh list
                    } catch (err) {
                        console.error(err);
                    }
                }

                async function clearResolvedErrors() {
                    if (!confirm('Clear all resolved errors?')) return;
                    try {
                        await authFetch('/admin/monitoring/errors/clear', { method: 'POST' });
                        fetchErrors();
                    } catch (err) {
                        console.error(err);
                    }
                }

                async function createBackup() {
                    const button = document.getElementById('backup-btn');
                    const statusEl = document.getElementById('backup-status');
                    if (statusEl) {
                        statusEl.textContent = '';
                        statusEl.style.color = '';
                    }

                    if (button) {
                        button.disabled = true;
                        button.textContent = '📦 Creating...';
                    }

                    try {
                        const response = await authFetch('/admin/monitoring/backup', { method: 'POST' });
                        const json = await response.json().catch(() => ({}));

                        if (json && json.success) {
                            if (statusEl) {
                                statusEl.textContent = 'Backup created successfully.';
                                statusEl.style.color = '#22c55e';
                            }
                            fetchBackups();
                        } else {
                            const message = (json && (json.message || json.error)) || 'Failed to create backup';
                            if (statusEl) {
                                statusEl.textContent = message;
                                statusEl.style.color = '#ef4444';
                            }
                        }
                    } catch (error) {
                        console.error('Error creating backup:', error);
                        if (statusEl) {
                            statusEl.textContent = 'Error creating backup';
                            statusEl.style.color = '#ef4444';
                        }
                    } finally {
                        if (button) {
                            button.disabled = false;
                            button.textContent = '📦 Create Backup';
                        }
                    }
                }

                async function restartServer() {
                    const confirmed = confirm('Are you sure you want to restart the server? This will disconnect all users.');
                    if (!confirmed) return;

                    try {
                        const response = await authFetch('/admin/monitoring/restart', { method: 'POST' });
                        const json = await response.json().catch(() => ({}));

                        if (json && json.success) {
                            alert(json.message || 'Server restart initiated. Please wait a few seconds and refresh the page.');
                        } else {
                            alert((json && (json.message || json.error)) || 'Failed to restart server');
                        }
                    } catch (error) {
                        console.error('Error restarting server:', error);
                        alert('Error restarting server');
                    }
                }

                // --- MongoDB Query Tool ---
                async function fetchCollections() {
                    const select = document.getElementById('query-collection');
                    if (select.options.length > 1) return; // Already loaded

                    try {
                        const res = await authFetch('/admin/monitoring/db/collections');
                        const json = await res.json();
                        if (json.success) {
                            select.innerHTML = '<option value="">Select Collection</option>' +
                                json.data.map(c => `<option value="${c}">${c}</option>`).join('');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Failed to fetch collections');
                    }
                }

                async function runQuery() {
                    const collection = document.getElementById('query-collection').value;
                    const operation = document.getElementById('query-operation').value;
                    const queryStr = document.getElementById('query-input').value;
                    const resultsPre = document.getElementById('query-results');

                    if (!collection) return alert('Please select a collection');

                    resultsPre.textContent = 'Running...';
                    resultsPre.style.color = '#fbbf24'; // Warning color

                    try {
                        let query = {};
                        try {
                            query = JSON.parse(queryStr);
                        } catch (e) {
                            return alert('Invalid JSON query');
                        }

                        const res = await authFetch('/admin/monitoring/db/query', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ collection, operation, query })
                        });

                        const json = await res.json();
                        if (json.success) {
                            resultsPre.textContent = JSON.stringify(json.data, null, 2);
                            resultsPre.style.color = '#10b981'; // Success color
                        } else {
                            resultsPre.textContent = 'Error: ' + json.error;
                            resultsPre.style.color = '#ef4444'; // Error color
                        }
                    } catch (err) {
                        resultsPre.textContent = 'Error: ' + err.message;
                        resultsPre.style.color = '#ef4444';
                    }
                }

                // --- Data Fetching ---
                async function fetchData() {
                    try {
                        // Server Metrics
                        const res = await authFetch('/admin/monitoring/metrics');
                        const json = await res.json();
                        if (DEBUG) {
                            console.log('Metrics response:', json);
                        }
                        if (json.success) {
                            updateDashboard(json.data);
                        } else {
                            console.error('Metrics fetch failed:', json);
                        }

                        // DB Stats
                        const dbRes = await authFetch('/admin/monitoring/db/stats');
                        const dbJson = await dbRes.json();
                        if (DEBUG) {
                            console.log('DB stats response:', dbJson);
                        }
                        if (dbJson.success) {
                            updateDbStats(dbJson.data);
                        } else {
                            console.error('DB stats fetch failed:', dbJson);
                        }

                        // Network Stats
                        const netRes = await authFetch('/admin/monitoring/network/stats');
                        const netJson = await netRes.json();
                        if (DEBUG) {
                            console.log('Network stats response:', netJson);
                        }
                        if (netJson.success) {
                            updateNetworkStats(netJson.data);
                        } else {
                            console.error('Network stats fetch failed:', netJson);
                        }
                    } catch (e) {
                        console.error('Error fetching data:', e);
                    }
                }

                function updateDashboard(data) {
                    if (!data || !data.server) {
                        console.warn('Invalid dashboard data:', data);
                        return;
                    }
                    const server = data.server;
                    const memory = server.memory || {};
                    const system = data.system || {};

                    // Top summary stats
                    const uptimeEl = document.getElementById('uptime-stat');
                    const memStatEl = document.getElementById('memory-stat');
                    if (uptimeEl) uptimeEl.textContent = formatUptime(server.uptime || 0);
                    if (memStatEl) {
                        const heapTotal = memory.heapTotal || memory.heapTotalBytes || 0;
                        if (heapTotal > 0) {
                            const percent = (memory.heapUsed || 0) / heapTotal * 100;
                            memStatEl.textContent = `${percent.toFixed(1)}%`;
                        } else {
                            memStatEl.textContent = '0.0%';
                        }
                    }

                    // Detailed memory + CPU section
                    const time = new Date().toLocaleTimeString();

                    const memRssEl = document.getElementById('memory-rss');
                    if (memRssEl) memRssEl.textContent = formatBytes(memory.rss || 0);
                    const cpuUsageEl = document.getElementById('cpu-usage');
                    if (cpuUsageEl) cpuUsageEl.textContent = (server.cpu || 0) + '%';

                    const pidEl = document.getElementById('pid');
                    if (pidEl) pidEl.textContent = server.pid || '--';
                    const nodeVersionEl = document.getElementById('nodeVersion');
                    if (nodeVersionEl) nodeVersionEl.textContent = server.nodeVersion || '--';
                    const platformEl = document.getElementById('platform');
                    if (platformEl) platformEl.textContent = server.platform || '--';

                    const heapUsedEl = document.getElementById('memory-heap');
                    if (heapUsedEl) heapUsedEl.textContent = formatBytes(memory.heapUsed || 0);
                    const heapProgressEl = document.getElementById('heap-progress');
                    if (heapProgressEl && memory.heapTotal) {
                        const heapPercent = (memory.heapUsed || 0) / memory.heapTotal * 100;
                        heapProgressEl.style.width = `${heapPercent.toFixed(1)}%`;
                    }

                    const hostnameEl = document.getElementById('hostname');
                    if (hostnameEl) hostnameEl.textContent = system.hostname || '--';
                    const cpusEl = document.getElementById('cpus');
                    if (cpusEl) cpusEl.textContent = system.cpus || '--';
                    const loadAvgEl = document.getElementById('load-avg');
                    if (loadAvgEl) {
                        const loadAvg = Array.isArray(system.loadAverage) && system.loadAverage.length > 0
                            ? Number(system.loadAverage[0]).toFixed(2)
                            : '--';
                        loadAvgEl.textContent = loadAvg;
                    }
                    const projectSizeEl = document.getElementById('project-size');
                    if (projectSizeEl) projectSizeEl.textContent = formatBytes(system.projectSize || 0);

                    if (memoryChart) {
                        const heapUsedMb = ((memory.heapUsed || 0) / 1024 / 1024).toFixed(2);
                        addDataToChart(memoryChart, time, heapUsedMb);
                    }

                    if (cpuChart) {
                        addDataToChart(cpuChart, time, server.cpu || 0);
                    }
                }

                function updateDbStats(data) {
                    if (!data) {
                        console.warn('Invalid DB stats data:', data);
                        return;
                    }

                    const storage = data.storage || {};
                    const connections = data.connections || {};
                    const collections = data.collections || [];

                    const dbDataSizeEl = document.getElementById('db-data-size');
                    if (dbDataSizeEl) dbDataSizeEl.textContent = formatBytes(storage.dataSize || 0);
                    const dbObjectsEl = document.getElementById('db-objects');
                    if (dbObjectsEl) dbObjectsEl.textContent = storage.objects || 0;
                    const dbIndexSizeEl = document.getElementById('db-index-size');
                    if (dbIndexSizeEl) dbIndexSizeEl.textContent = formatBytes(storage.indexSize || 0);

                    const currentEl = document.getElementById('db-conn-current');
                    const availableEl = document.getElementById('db-conn-available');
                    const activeEl = document.getElementById('db-conn-active');
                    if (currentEl) currentEl.textContent = connections.current || '--';
                    if (availableEl) availableEl.textContent = connections.available || '--';
                    if (activeEl) activeEl.textContent = connections.active || '--';

                    if (dbStorageChart) {
                        const dataSize = storage.dataSize || 0;
                        const indexSize = storage.indexSize || 0;
                        const storageSize = storage.storageSize || 0;
                        const freeSpace = Math.max(storageSize - dataSize - indexSize, 0);
                        dbStorageChart.data.datasets[0].data = [dataSize, indexSize, freeSpace];
                        dbStorageChart.update();
                    }

                    renderCollections(collections);
                }

                function renderCollections(collections) {
                    const tbody = document.getElementById('db-collections-list');
                    if (!tbody) return;

                    if (!collections || !Array.isArray(collections) || collections.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-muted);">No collections found</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = collections.map((col) => {
                        return `<tr style="border-bottom: 1px solid rgba(255,255,255,0.08);">
            <td style="padding: 10px;">${escapeHtml(col.name || 'Unknown')}</td>
            <td style="padding: 10px;">${(col.count || 0).toLocaleString()}</td>
            <td style="padding: 10px;">${formatBytes(col.size || 0)}</td>
            <td style="padding: 10px;">${formatBytes(col.storageSize || 0)}</td>
            <td style="padding: 10px;">${col.indexes || 0}</td>
        </tr>`;
                    }).join('');
                }

                function updateNetworkStats(data) {
                    if (!data) {
                        console.warn('Invalid network stats data:', data);
                        return;
                    }
                    const metrics = data;

                    const activeConnections = metrics.activeConnections ?? metrics.connections ?? 0;
                    const rps = metrics.requestsPerSecond ?? metrics.rps ?? 0;
                    const avgLatency = metrics.averageLatency ?? metrics.latency ?? 0;
                    const totalBandwidth = metrics.totalBandwidth ?? metrics.bandwidth ?? 0;

                    const netConnectionsEl = document.getElementById('net-connections');
                    if (netConnectionsEl) netConnectionsEl.textContent = activeConnections;
                    const netRpsEl = document.getElementById('net-rps');
                    if (netRpsEl) netRpsEl.textContent = rps;
                    const netBandwidthEl = document.getElementById('net-bandwidth');
                    if (netBandwidthEl) netBandwidthEl.textContent = formatBytes(totalBandwidth);

                    const time = new Date().toLocaleTimeString();
                    if (netRpsChart) {
                        addDataToChart(netRpsChart, time, rps);
                    }
                    if (netLatencyChart) {
                        addDataToChart(netLatencyChart, time, avgLatency);
                    }
                }

                // --- Data Fetching (deduplicated) ---
                // NOTE: fetchData, updateDashboard, updateDbStats, updateNetworkStats are defined once above.

                function addDataToChart(chart, label, data) {
                    chart.data.labels.push(label);
                    chart.data.datasets.forEach((dataset) => {
                        dataset.data.push(data);
                    });

                    if (chart.data.labels.length > maxDataPoints) {
                        chart.data.labels.shift();
                        chart.data.datasets.forEach((dataset) => {
                            dataset.data.shift();
                        });
                    }

                    chart.update();
                }

                function connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                    const wsUrl = `${protocol}://${window.location.host}/admin/monitoring/logs/stream`;
                    if (ws && ws.readyState !== WebSocket.CLOSED) {
                        try {
                            ws.close();
                        } catch (err) {
                            console.warn('Failed to close existing WebSocket connection:', err);
                        }
                    }

                    const updateStatus = (label, variant) => {
                        const statusEl = document.getElementById('ws-status');
                        if (!statusEl) return;
                        statusEl.textContent = label;
                        statusEl.className = `badge badge-${variant}`;
                    };

                    try {
                        ws = new WebSocket(wsUrl);
                    } catch (err) {
                        console.error('Failed to initialize WebSocket:', err);
                        scheduleReconnect();
                        return;
                    }

                    ws.onopen = () => {
                        reconnectAttempts = 0;
                        updateStatus('Connected', 'success');
                    };

                    ws.onmessage = (event) => {
                        try {
                            const payload = JSON.parse(event.data);
                            handleLogPayload(payload);
                        } catch (err) {
                            console.error('Failed to parse log payload:', err);
                        }
                    };

                    ws.onerror = (event) => {
                        console.error('WebSocket error:', event);
                        updateStatus('Error', 'danger');
                    };

                    ws.onclose = () => {
                        updateStatus('Disconnected', 'danger');
                        scheduleReconnect();
                    };

                    function scheduleReconnect() {
                        const baseDelay = 3000;
                        const delay = Math.min(baseDelay * Math.pow(2, reconnectAttempts), 30000);
                        reconnectAttempts += 1;
                        if (reconnectTimer) clearTimeout(reconnectTimer);
                        reconnectTimer = setTimeout(() => connectWebSocket(), delay);
                        updateStatus('Reconnecting...', 'warning');
                    }

                    function handleLogPayload(payload) {
                        if (!payload) return;
                        const entries = [];
                        if (payload.type === 'history' && (Array.isArray(payload.logs) || Array.isArray(payload.data))) {
                            if (Array.isArray(payload.logs)) entries.push(...payload.logs);
                            if (Array.isArray(payload.data)) entries.push(...payload.data);
                        } else if (payload.type === 'log' && payload.log) {
                            entries.push(payload.log);
                        } else if (payload.type === 'log' && payload.data) {
                            entries.push(payload.data);
                        } else if (Array.isArray(payload)) {
                            entries.push(...payload);
                        } else {
                            entries.push(payload);
                        }

                        entries.forEach((entry) => {
                            if (!entry) return;
                            logs.push({
                                timestamp: entry.timestamp || entry.time || entry.createdAt || Date.now(),
                                level: (entry.level || entry.severity || 'INFO').toUpperCase(),
                                message: entry.message || entry.text || entry.msg || ''
                            });
                        });

                        if (logs.length > logHistoryLimit) {
                            logs = logs.slice(-logHistoryLimit);
                        }

                        renderLogs();
                    }
                }

                async function fetchBackups() {
                    const backupBody = document.getElementById('backup-list');
                    if (!backupBody) return;
                    backupBody.innerHTML = `<tr><td colspan="4" style="padding: 15px; text-align: center; color: var(--text-muted);">Loading backups...</td></tr>`;
                    try {
                        const response = await authFetch('/admin/monitoring/backups');
                        const json = await response.json();
                        const backups = Array.isArray(json)
                            ? json
                            : Array.isArray(json.data)
                                ? json.data
                                : [];
                        if (!backups.length && !Array.isArray(json) && !Array.isArray(json.data)) {
                            throw new Error((json && json.message) || 'Request failed');
                        }
                        if (!backups.length) {
                            backupBody.innerHTML = `<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--text-muted);">No backups found</td></tr>`;
                            return;
                        }

                        backupBody.innerHTML = backups.map((backup) => {
                            const filename = backup.filename || backup.name || 'Unknown';
                            const size = formatBytes(backup.size || 0);
                            const created = backup.created || backup.createdAt || backup.date;
                            const createdText = created ? new Date(created).toLocaleString() : 'Unknown';
                            return `<tr>
                                    <td style="padding: 10px;">${escapeHtml(filename)}</td>
                                    <td style="padding: 10px;">${size}</td>
                                    <td style="padding: 10px;">${createdText}</td>
                                    <td style="padding: 10px;">
                                        <button class="btn-premium btn-secondary btn-small" onclick='downloadBackup(${JSON.stringify(filename)})'>⬇ Download</button>
                                    </td>
                                </tr>`;
                        }).join('');
                    } catch (error) {
                        console.error('Failed to load backups:', error);
                        backupBody.innerHTML = `<tr><td colspan="4" style="padding: 20px; text-align: center; color: #f87171;">Failed to load backups</td></tr>`;
                    }
                }

                function downloadBackup(filename) {
                    if (!filename) return;
                    const anchor = document.createElement('a');
                    anchor.href = `/admin/monitoring/download/${encodeURIComponent(filename)}`;
                    anchor.download = filename;
                    document.body.appendChild(anchor);
                    anchor.click();
                    document.body.removeChild(anchor);
                }

                async function fetchEnvVars() {
                    try {
                        const response = await authFetch('/admin/monitoring/env');
                        const json = await response.json();
                        if (!json.success) throw new Error(json.message || 'Failed to fetch environment variables');
                        envVars = [];
                        if (json.data && Array.isArray(json.data.variables)) {
                            envVars = json.data.variables.map((v) => ({
                                key: v.key,
                                value: v.value
                            }));
                        } else {
                            const content = typeof json.data === 'string'
                                ? json.data
                                : (json.data && (json.data.content || json.data.env)) || '';
                            content.split(/\r?\n/).forEach((line) => {
                                const trimmed = line.trim();
                                if (!trimmed || trimmed.startsWith('#')) return;
                                const [key, ...rest] = trimmed.split('=');
                                if (!key) return;
                                envVars.push({
                                    key: key.trim(),
                                    value: rest.join('=').trim()
                                });
                            });
                        }
                        renderEnvVars();
                    } catch (error) {
                        console.error('Failed to fetch env vars:', error);
                    }
                }

                function renderEnvVars() {
                    const body = document.getElementById('env-vars-body');
                    if (!body) return;
                    if (!envVars.length) {
                        body.innerHTML = `<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">No environment variables</td></tr>`;
                        return;
                    }

                    body.innerHTML = envVars.map((env, index) => {
                        const valueField = showValues
                            ? `<input type="text" class="search-box" value="${escapeHtml(env.value || '')}" oninput="envVars[${index}].value = this.value" />`
                            : `<span style="letter-spacing: 2px;">••••••••</span>`;
                        return `<tr>
                                <td style="padding: 8px; width: 30%;">
                                    <input type="text" class="search-box" value="${escapeHtml(env.key || '')}" readonly />
                                </td>
                                <td style="padding: 8px; width: 60%;">${valueField}</td>
                                <td style="padding: 8px; width: 10%;">
                                    <button class="btn-premium btn-danger btn-small" onclick="removeEnvVar(${index})">Remove</button>
                                </td>
                            </tr>`;
                    }).join('');
                }

                async function fetchErrors(page = 1) {
                    const tableBody = document.getElementById('errors-list');
                    if (!tableBody) return;
                    tableBody.innerHTML = `<tr><td colspan="5" style="padding: 15px; text-align: center; color: var(--text-muted);">Loading errors...</td></tr>`;
                    const params = new URLSearchParams();
                    params.set('page', page);
                    params.set('limit', errorPagination.limit || 50);
                    const statusFilter = document.getElementById('error-status-filter');
                    if (statusFilter && statusFilter.value) {
                        params.set('status', statusFilter.value);
                    }
                    try {
                        const response = await authFetch(`/admin/monitoring/errors?${params.toString()}`);
                        const json = await response.json();
                        if (!json.success) throw new Error(json.message || 'Failed to fetch errors');
                        const pagination = json.pagination || {};
                        errorPagination = {
                            page: pagination.page || page,
                            limit: pagination.limit || errorPagination.limit,
                            totalPages: pagination.totalPages || pagination.pages || 1,
                            total: pagination.total || pagination.totalItems || (Array.isArray(json.data) ? json.data.length : 0)
                        };
                        renderErrors(Array.isArray(json.data) ? json.data : []);
                    } catch (error) {
                        console.error('Failed to load errors:', error);
                        tableBody.innerHTML = `<tr><td colspan="5" style="padding: 20px; text-align: center; color: #f87171;">Failed to load errors</td></tr>`;
                    }
                }

                function renderErrors(errors = []) {
                    const tableBody = document.getElementById('errors-list');
                    if (!tableBody) return;
                    if (!errors || !Array.isArray(errors) || errors.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-muted);">No errors found</td></tr>`;
                        return;
                    }

                    tableBody.innerHTML = errors.map((error) => {
                        const timestamp = error.timestamp || error.time || error.createdAt || Date.now();
                        const level = (error.level || error.severity || 'INFO').toUpperCase();
                        const status = (error.status || 'active').toLowerCase();
                        const message = error.message || error.msg || '';
                        const truncated = message.length > 100 ? `${message.slice(0, 97)}...` : message;
                        const levelClass = level === 'ERROR' ? 'badge-danger' : level === 'WARN' ? 'badge-warning' : 'badge-info';
                        const statusClass = status === 'resolved' ? 'badge-success'
                            : status === 'ignored' ? 'badge-secondary'
                                : 'badge-warning';
                        const id = error._id || error.id || '';
                        const detail = error.stack || error.stackTrace || error.details || message || 'No details available';
                        const resolveButton = status === 'resolved'
                            ? ''
                            : `<button class="btn-premium btn-success btn-small" onclick="updateErrorStatus('${id}', 'resolved')">Resolve</button>`;
                        return `<tr>
                                <td style="padding: 10px;">${new Date(timestamp).toLocaleString()}</td>
                                <td style="padding: 10px;"><span class="badge ${levelClass}">${level}</span></td>
                                <td style="padding: 10px;">${escapeHtml(truncated)}</td>
                                <td style="padding: 10px;"><span class="badge ${statusClass}">${status.toUpperCase()}</span></td>
                                <td style="padding: 10px; display: flex; gap: 6px; flex-wrap: wrap;">
                                    ${resolveButton}
                                    <button class="btn-premium btn-secondary btn-small" onclick="alert(${JSON.stringify(detail)})">View</button>
                                </td>
                            </tr>`;
                    }).join('');
                }

                function renderLogs() {
                    const container = document.getElementById('logs-container');
                    if (!container) return;
                    const searchInput = document.getElementById('log-search');
                    const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
                    const filtered = logs.filter((log) => {
                        const levelMatch = currentLevel === 'ALL' || log.level === currentLevel;
                        const message = (log.message || '').toLowerCase();
                        const queryMatch = !query || message.includes(query) || (log.level || '').toLowerCase().includes(query);
                        return levelMatch && queryMatch;
                    });

                    if (!filtered.length) {
                        container.innerHTML = `<div style="padding: 15px; text-align: center; color: var(--text-muted);">No logs available</div>`;
                        return;
                    }

                    const subset = filtered.slice(-logHistoryLimit);
                    container.innerHTML = subset.map((log) => {
                        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                        const level = log.level || 'INFO';
                        const levelClass = level === 'ERROR' ? 'badge-danger' : level === 'WARN' ? 'badge-warning' : 'badge-info';
                        return `<div style="display: flex; gap: 10px; align-items: center; padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-family: 'JetBrains Mono', monospace;">
                                <span style="color: var(--text-muted); min-width: 90px;">${timestamp}</span>
                                <span class="badge ${levelClass}">${level}</span>
                                <span style="flex: 1; color: var(--text-color);">${escapeHtml(log.message || '')}</span>
                            </div>`;
                    }).join('');

                    const autoScroll = document.getElementById('auto-scroll');
                    if (autoScroll && autoScroll.checked) {
                        container.scrollTop = container.scrollHeight;
                    }
                }

                function setLogLevel(level) {
                    currentLevel = level;
                    renderLogs();
                }

                function filterLogs() {
                    renderLogs();
                }

                function clearLogs() {
                    logs = [];
                    renderLogs();
                }

                function addEnvVar() {
                    const keyInput = document.getElementById('new-env-key');
                    const valueInput = document.getElementById('new-env-value');
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key) {
                        envVars.push({ key, value });
                        keyInput.value = '';
                        valueInput.value = '';
                        renderEnvVars();
                    }
                }

                function removeEnvVar(index) {
                    envVars.splice(index, 1);
                    renderEnvVars();
                }

                function toggleMask() {
                    showValues = !showValues;
                    const btn = document.getElementById('mask-text');
                    if (btn) btn.textContent = showValues ? 'Hide Values' : 'Show Values';
                    renderEnvVars();
                }

                async function saveEnvVars() {
                    const content = envVars.map(env => `${ env.key }=${ env.value } `).join('\n');
                    try {
                        const response = await authFetch('/admin/monitoring/env', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content })
                        });
                        const json = await response.json();
                        if (json.success) {
                            alert('Environment variables saved successfully!');
                        } else {
                            alert('Failed to save: ' + json.message);
                        }
                    } catch (error) {
                        console.error('Error saving env vars:', error);
                        alert('Error saving environment variables');
                    }
                }

                // --- Helpers ---
                function escapeHtml(value = '') {
                    return String(value || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                function formatBytes(bytes, decimals = 2) {
                    if (!+bytes) return '0 Bytes';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${ parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) } ${ sizes[i] } `;
                }

                function formatUptime(seconds) {
                    const d = Math.floor(seconds / (3600 * 24));
                    const h = Math.floor(seconds % (3600 * 24) / 3600);
                    const m = Math.floor(seconds % 3600 / 60);
                    const s = Math.floor(seconds % 60);
                    return `${ d }d ${ h }h ${ m }m ${ s } s`;
                }

                  // --- Initialization ---
                  document.addEventListener('DOMContentLoaded', () => {
                    try {
                        initCharts().catch((err) => console.error('Failed to initialize charts:', err));
                    } catch (e) {
                        console.error('Failed to initialize charts:', e);
                    }

                    try {
                        connectWebSocket();
                    } catch (e) {
                        console.error('Failed to connect WebSocket:', e);
                    }

                    try {
                        fetchData();
                        setInterval(fetchData, 5000);
                    } catch (e) {
                        console.error('Failed to fetch data:', e);
                    }

                    try {
                        fetchBackups();
                    } catch (e) {
                        console.error('Failed to fetch backups:', e);
                    }

                    try {
                        fetchEnvVars();
                    } catch (e) {
                        console.error('Failed to fetch env vars:', e);
                    }
                });
            </script>
</body>

</html>
